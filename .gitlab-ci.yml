stages:
  - docker
  - build
  - release

variables:
  CI_IMAGE: $CI_REGISTRY_IMAGE/ci:latest

# Build the CI Docker image when Dockerfile changes
build-docker:
  stage: docker
  image: docker:latest
  services:
    - docker:dind
  rules:
    - changes:
        - .ci/Dockerfile
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
      allow_failure: true
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_IMAGE -f .ci/Dockerfile .
    - docker push $CI_IMAGE

# Build the project
build:
  stage: build
  image: $CI_IMAGE
  cache:
    key:
      files:
        - Cargo.lock
        - orbit/Cargo.lock
        - orbit-android/Cargo.lock
    paths:
      - .cargo/registry
      - .cargo/git
      - target/
      - android/.gradle
      - android/app/build
  variables:
    CARGO_HOME: $CI_PROJECT_DIR/.cargo
  script:
    - chmod +x .ci/build.sh
    - ./.ci/build.sh
  artifacts:
    paths:
      - artifacts/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_TAG

# Create a release when a tag is pushed
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: "Release $CI_COMMIT_TAG"
    assets:
      links:
        - name: "Orbit Android APK"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/artifacts/app-release-unsigned.apk"
          link_type: package
        - name: "orbitd Linux binary"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/artifacts/orbitd"
          link_type: other
